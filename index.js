const { default: makeWASocket, useMultiFileAuthState } = require('@whiskeysockets/baileys');
const axios = require('axios');
const express = require('express');
const WebSocket = require('ws');
const { ChartJSNodeCanvas } = require('chartjs-node-canvas');

const app = express();
app.use(express.json());

const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyhBq6PwVKFdXf0ZYfuvKO5LL5TvW56gdAgVoEauC2HePad8I4TMuhFT8fDd0TPEOEd9A/exec'; // Substitua pela URL do seu Google Apps Script
const GRUPO_ID = '120363403512588677@g.us'; // ID do grupo do WhatsApp

// Configura√ß√£o do gr√°fico
const width = 800; // Largura do gr√°fico
const height = 600; // Altura do gr√°fico
const backgroundColour = 'white'; // Cor de fundo

const chartJSNodeCanvas = new ChartJSNodeCanvas({
  width,
  height,
  backgroundColour
});

async function gerarGrafico(tipo, dados) {
  const configuration = {
    type: tipo,
    data: {
      labels: dados.labels,
      datasets: dados.datasets // Agora recebe m√∫ltiplos datasets
    },
    options: {
      responsive: true,
      plugins: {
        title: { 
          display: true, 
          text: dados.titulo,
          font: { size: 18 }
        },
        legend: {
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'R$ ' + value.toFixed(2);
            }
          }
        }
      }
    }
  };

  return chartJSNodeCanvas.renderToBuffer(configuration);
}

async function iniciarBot() {
  const { state, saveCreds } = await useMultiFileAuthState('auth_info');
  const sock = makeWASocket({ 
    auth: state,
    printQRInTerminal: true // Exibe o QR Code no terminal
  });

  sock.ev.on('creds.update', saveCreds);

  sock.ev.on('connection.update', (update) => {
    const { connection, qr } = update;

    // Exibe o QR Code no terminal
    if (qr) {
      console.log('Escaneie o QR Code abaixo para autenticar o bot:');
      console.log(`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qr)}`);
    }

    if (connection === 'open') {
      console.log('Bot conectado ao WhatsApp!');
    } else if (connection === 'close') {
      console.log('Conex√£o fechada, tentando reconectar...');
      setTimeout(iniciarBot, 5000);
    }
  });

  sock.ev.on('messages.upsert', async ({ messages }) => {
    const msg = messages[0];
    if (!msg.message || !msg.key.remoteJid.includes(GRUPO_ID)) return;

    const texto = msg.message.conversation?.toLowerCase().trim();
    if (!texto) return;

    console.log(`Comando recebido: ${texto}`);

    // Comando de ajuda
    if (["ajuda", "help", "comandos", "comando"].includes(texto)) {
      const mensagemAjuda = `üìù *Comandos Dispon√≠veis* üìù\n
      ‚Ä¢ "resumo" - Mostra o resumo financeiro completo\n
      ‚Ä¢ "meta" - Exibe detalhes da meta atual\n
      ‚Ä¢ "meta definir [valor] [dataInicio] [dataFim]" - Define uma nova meta\n
      ‚Ä¢ "entrada [valor] [descri√ß√£o]" - Registra uma entrada\n
      ‚Ä¢ "sa√≠da [valor] [descri√ß√£o]" - Registra uma sa√≠da\n
      ‚Ä¢ "m√©dia" - Mostra a m√©dia das entradas\n
      ‚Ä¢ "historico [dias]" - Mostra o hist√≥rico de transa√ß√µes\n
      ‚Ä¢ "relatorio [dataInicio] [dataFim]" - Gera um relat√≥rio personalizado\n
      ‚Ä¢ "dividir [valor] [pessoas]" - Divide despesas\n
      ‚Ä¢ "converter [valor] [moedaOrigem] [moedaDestino]" - Converte moedas\n
      ‚Ä¢ "investir [valor] [taxa] [tempo]" - Simula investimentos\n
      ‚Ä¢ "analise" - Gera an√°lise de gastos\n
      ‚Ä¢ "recorrente adicionar [valor] [descri√ß√£o] [frequ√™ncia]" - Adiciona despesa recorrente\n
      ‚Ä¢ "recorrente listar" - Lista despesas recorrentes\n
      ‚Ä¢ "orcamento definir [categoria] [valor]" - Define or√ßamento\n
      ‚Ä¢ "divida adicionar [valor] [credor] [data]" - Adiciona d√≠vida\n
      ‚Ä¢ "alerta gasto [percentual]" - Configura alerta de gastos\n
      ‚Ä¢ "grafico [tipo] [dados] [periodo]" - Gera gr√°fico financeiro\n
      ‚Ä¢ "ajuda" - Exibe esta mensagem`;
      await sock.sendMessage(GRUPO_ID, { text: mensagemAjuda });
      return;
    }

    // Comando para gr√°ficos
    if (texto.startsWith('grafico')) {
      const partes = texto.split(' ');
      if (partes.length < 3) return;

      const tipoGrafico = partes[1]; // bar, line
      const tipoDados = partes[2].toLowerCase(); // entrada, saida, ambos
      const periodo = partes[3] ? partes[3].toLowerCase() : "todos"; // diario, semanal, mensal, ou todos

      try {
        const response = await axios.get(`${WEB_APP_URL}?action=getDadosGrafico&tipo=${tipoDados}&periodo=${periodo}`, {
          timeout: 15000
        });

        if (!response.data.labels || response.data.labels.length === 0) {
          await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Nenhum dado encontrado para o per√≠odo!" });
          return;
        }

        const image = await gerarGrafico(tipoGrafico, response.data);
        await sock.sendMessage(GRUPO_ID, { 
          image: image, 
          caption: `üìä ${response.data.titulo}\nüìÖ Per√≠odo: ${periodo}`
        });

      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para resumo financeiro
    if (texto.startsWith('resumo')) {
      try {
        const response = await axios.get(`${WEB_APP_URL}?action=resumoDiario`);
        const resumoDiario = response.data;

        const responseSemanal = await axios.get(`${WEB_APP_URL}?action=resumoSemanal`);
        const resumoSemanal = responseSemanal.data;

        const responseMensal = await axios.get(`${WEB_APP_URL}?action=resumoMensal`);
        const resumoMensal = responseMensal.data;

        const mensagem = `üìä *Resumo Financeiro* üìä\n
        üìÖ *Di√°rio*\n
        üí∞ Entradas: R$${resumoDiario.entrada}\n
        üí∏ Sa√≠das: R$${resumoDiario.saida}\n
        üè¶ Saldo: R$${resumoDiario.saldo}\n\n
        üìÖ *Semanal*\n
        üí∞ Entradas: R$${resumoSemanal.entrada}\n
        üí∏ Sa√≠das: R$${resumoSemanal.saida}\n
        üè¶ Saldo: R$${resumoSemanal.saldo}\n\n
        üìÖ *Mensal*\n
        üí∞ Entradas: R$${resumoMensal.entrada}\n
        üí∏ Sa√≠das: R$${resumoMensal.saida}\n
        üè¶ Saldo: R$${resumoMensal.saldo}`;

        await sock.sendMessage(GRUPO_ID, { text: mensagem });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para definir meta
    if (texto.startsWith('meta definir')) {
      const partes = texto.split(' ');
      if (partes.length < 5) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: meta definir [valor] [dataInicio] [dataFim]" });
        return;
      }

      const valor = partes[2];
      const dataInicio = partes[3];
      const dataFim = partes[4];

      try {
        const response = await axios.post(`${WEB_APP_URL}?action=definirMeta`, {
          valor: valor,
          dataInicio: dataInicio,
          dataFim: dataFim
        });

        await sock.sendMessage(GRUPO_ID, { text: `‚úÖ Meta definida com sucesso!` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para registrar entrada
    if (texto.startsWith('entrada')) {
      const partes = texto.split(' ');
      if (partes.length < 3) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: entrada [valor] [descri√ß√£o]" });
        return;
      }

      const valor = partes[1];
      const descricao = partes.slice(2).join(' ');

      try {
        const response = await axios.post(`${WEB_APP_URL}?action=registrarEntrada`, {
          valor: valor,
          descricao: descricao,
          remetente: msg.pushName // Adiciona o nome do usu√°rio
        });

        await sock.sendMessage(GRUPO_ID, { text: `‚úÖ Entrada registrada com sucesso por ${msg.pushName}: ${descricao} - R$${valor}` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para registrar sa√≠da
    if (texto.startsWith('sa√≠da')) {
      const partes = texto.split(' ');
      if (partes.length < 3) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: sa√≠da [valor] [descri√ß√£o]" });
        return;
      }

      const valor = partes[1];
      const descricao = partes.slice(2).join(' ');

      try {
        const response = await axios.post(`${WEB_APP_URL}?action=registrarSaida`, {
          valor: valor,
          descricao: descricao,
          remetente: msg.pushName // Adiciona o nome do usu√°rio
        });

        await sock.sendMessage(GRUPO_ID, { text: `‚úÖ Sa√≠da registrada com sucesso por ${msg.pushName}: ${descricao} - R$${valor}` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para hist√≥rico de transa√ß√µes
    if (texto.startsWith('historico')) {
      const partes = texto.split(' ');
      const periodo = partes[1] ? parseInt(partes[1]) : 7; // Padr√£o: √∫ltimos 7 dias

      try {
        const response = await axios.get(`${WEB_APP_URL}?action=historico&periodo=${periodo}`);
        const historico = response.data;

        let mensagem = `üìú Hist√≥rico dos √∫ltimos ${periodo} dias:\n`;
        historico.forEach(transacao => {
          const tipo = transacao[1] === "Entrada" ? "‚úÖ" : "‚ùå";
          mensagem += `${tipo} ${transacao[1]}: R$${transacao[2]} - ${transacao[3]} (${transacao[0]})\n`;
        });

        await sock.sendMessage(GRUPO_ID, { text: mensagem });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para relat√≥rio personalizado
    if (texto.startsWith('relatorio')) {
      const partes = texto.split(' ');
      if (partes.length < 3) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: relatorio [dataInicio] [dataFim]" });
        return;
      }

      const dataInicio = partes[1];
      const dataFim = partes[2];

      try {
        const response = await axios.get(`${WEB_APP_URL}?action=relatorio&dataInicio=${dataInicio}&dataFim=${dataFim}`);
        const relatorio = response.data;

        const mensagem = `üìä Relat√≥rio de ${dataInicio} a ${dataFim}:\n
        ‚úÖ Total de entradas: R$${relatorio.entrada}\n
        ‚ùå Total de sa√≠das: R$${relatorio.saida}\n
        üìå Categorias mais gastas:\n
        1. Alimenta√ß√£o: R$${relatorio.categorias[0]}\n
        2. Contas Fixas: R$${relatorio.categorias[1]}\n
        3. Lazer: R$${relatorio.categorias[2]}\n
        üí∞ Saldo final: R$${relatorio.saldo}`;

        await sock.sendMessage(GRUPO_ID, { text: mensagem });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para dividir despesas
    if (texto.startsWith('dividir')) {
      const partes = texto.split(' ');
      if (partes.length < 3) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: dividir [valor] [pessoas]" });
        return;
      }

      const valor = parseFloat(partes[1]);
      const pessoas = parseInt(partes[2]);

      if (isNaN(valor) || isNaN(pessoas)) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Valor ou n√∫mero de pessoas inv√°lido." });
        return;
      }

      const valorPorPessoa = (valor / pessoas).toFixed(2);

      await sock.sendMessage(GRUPO_ID, { 
        text: `üí∞ Divis√£o de despesas:\nValor total: R$${valor}\nN√∫mero de pessoas: ${pessoas}\nCada pessoa deve pagar: R$${valorPorPessoa}`
      });
      return;
    }

    // Comando para simular investimentos
    if (texto.startsWith('investir')) {
      const partes = texto.split(' ');
      if (partes.length < 4) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: investir [valor] [taxa] [tempo]" });
        return;
      }

      const valor = parseFloat(partes[1]);
      const taxa = parseFloat(partes[2]);
      const tempo = parseInt(partes[3]);

      if (isNaN(valor) || isNaN(taxa) || isNaN(tempo)) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Valor, taxa ou tempo inv√°lido." });
        return;
      }

      const valorFinal = (valor * Math.pow(1 + (taxa / 100), tempo)).toFixed(2);

      await sock.sendMessage(GRUPO_ID, { 
        text: `üìà Simula√ß√£o de investimento:\nValor inicial: R$${valor}\nRendimento: ${taxa}% ao m√™s\nTempo: ${tempo} meses\nValor final estimado: R$${valorFinal}`
      });
      return;
    }

    // Comando para an√°lise de gastos
    if (texto.startsWith('analise')) {
      try {
        const response = await axios.get(`${WEB_APP_URL}?action=analise`);
        const analise = response.data;

        const mensagem = `üìä An√°lise de gastos:\n
        üìå Voc√™ gastou ${analise.percentualLazer}% a mais com Lazer neste m√™s comparado ao anterior.\n
        üìå Sua categoria "Alimenta√ß√£o" representa ${analise.percentualAlimentacao}% dos seus gastos totais.\n
        üîπ Dica: Reduzir gastos com lazer pode ajudar a poupar mais!`;

        await sock.sendMessage(GRUPO_ID, { text: mensagem });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para adicionar despesa recorrente
    if (texto.startsWith('recorrente adicionar')) {
      const partes = texto.split(' ');
      if (partes.length < 5) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: recorrente adicionar [valor] [descri√ß√£o] [frequ√™ncia]" });
        return;
      }

      const valor = partes[2];
      const descricao = partes[3];
      const frequencia = partes[4];

      try {
        const response = await axios.post(`${WEB_APP_URL}?action=adicionarRecorrente`, {
          valor: valor,
          descricao: descricao,
          frequencia: frequencia
        });

        await sock.sendMessage(GRUPO_ID, { text: `‚úÖ Despesa recorrente adicionada com sucesso: ${descricao} - R$${valor} (${frequencia})` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para listar despesas recorrentes
    if (texto.startsWith('recorrente listar')) {
      try {
        const response = await axios.get(`${WEB_APP_URL}?action=listarRecorrentes`);
        const recorrentes = response.data;

        let mensagem = `üìå Despesas recorrentes:\n`;
        recorrentes.forEach(recorrente => {
          mensagem += `- ${recorrente.descricao}: R$${recorrente.valor} (${recorrente.frequencia})\n`;
        });

        await sock.sendMessage(GRUPO_ID, { text: mensagem });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para definir or√ßamento
    if (texto.startsWith('orcamento definir')) {
      const partes = texto.split(' ');
      if (partes.length < 4) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: orcamento definir [categoria] [valor]" });
        return;
      }

      const categoria = partes[2];
      const valor = partes[3];

      try {
        const response = await axios.post(`${WEB_APP_URL}?action=definirOrcamento`, {
          categoria: categoria,
          valor: valor
        });

        await sock.sendMessage(GRUPO_ID, { text: `‚úÖ Or√ßamento definido com sucesso para ${categoria}: R$${valor}` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para adicionar d√≠vida
    if (texto.startsWith('divida adicionar')) {
      const partes = texto.split(' ');
      if (partes.length < 5) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: divida adicionar [valor] [credor] [data]" });
        return;
      }

      const valor = partes[2];
      const credor = partes[3];
      const data = partes[4];

      try {
        const response = await axios.post(`${WEB_APP_URL}?action=adicionarDivida`, {
          valor: valor,
          credor: credor,
          data: data
        });

        await sock.sendMessage(GRUPO_ID, { text: `‚úÖ D√≠vida adicionada com sucesso: ${credor} - R$${valor} (${data})` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para configurar alerta de gastos
    if (texto.startsWith('alerta gasto')) {
      const partes = texto.split(' ');
      if (partes.length < 3) {
        await sock.sendMessage(GRUPO_ID, { text: "‚ö†Ô∏è Formato incorreto. Use: alerta gasto [percentual]" });
        return;
      }

      const percentual = partes[2];

      try {
        const response = await axios.post(`${WEB_APP_URL}?action=configurarAlerta`, {
          percentual: percentual
        });

        await sock.sendMessage(GRUPO_ID, { text: `‚úÖ Alerta de gastos configurado com sucesso: ${percentual}%` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para exibir a meta atual
    if (texto.startsWith('meta')) {
      try {
        const response = await axios.get(`${WEB_APP_URL}?action=meta`);
        const meta = response.data;

        const mensagem = `üéØ Meta atual:\nValor: R$${meta.valor}\nData de in√≠cio: ${meta.dataInicio}\nData de fim: ${meta.dataFim}`;

        await sock.sendMessage(GRUPO_ID, { text: mensagem });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }

    // Comando para calcular a m√©dia das entradas
    if (texto.startsWith('m√©dia')) {
      try {
        const response = await axios.get(`${WEB_APP_URL}?action=mediaEntradas`);
        const media = response.data;

        await sock.sendMessage(GRUPO_ID, { text: `üìä M√©dia das entradas: R$${media.toFixed(2)}` });
      } catch (error) {
        console.error('Erro detalhado:', error);
        await sock.sendMessage(GRUPO_ID, { 
          text: `‚ùå Falha: ${error.response?.data?.error || error.message}`
        });
      }
      return;
    }
  });

  console.log("Bot iniciado!");
}

// Endpoint para receber mensagens do Google Apps Script
app.post('/enviar-mensagem', async (req, res) => {
  const { mensagem } = req.body;
  await sock.sendMessage(GRUPO_ID, { text: mensagem });
  res.status(200).send("Mensagem enviada com sucesso!");
});

// Iniciar o servidor Express e o bot
app.listen(3000, () => console.log("Servidor rodando na porta 3000"));
iniciarBot();